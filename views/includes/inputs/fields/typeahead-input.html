<script type="text/javascript" src="{{assetPath}}/javascripts/app/accessible-autocomplete.min.js"></script>
<script type="text/javascript">

  const typeahead = "{{typeahead_array}}"
  const typeaheadArray = typeahead.split(',');

  accessibleAutocomplete({
    element: document.querySelector('#my-autocomplete-container'),
    id: 'typeahead_input', // To match it to the existing <label>.
    source: typeaheadArray,
    name: 'typeahead_input',
    defaultValue:'{{typeahead_value}}'
  })

  // Add hint to JS-enabled title
  const hintElement = document.createElement('div');
  hintElement.id = 'typeahead-hint';
  hintElement.className = 'govuk-hint';
  hintElement.innerHTML = '{{typeaheadHint}}';
  const autocompleteContainer = document.getElementById("my-autocomplete-container");
  autocompleteContainer.insertBefore(hintElement, autocompleteContainer.childNodes[2]);

  // Mimic nunjucks error generation
  window.onload = function () {
    // Set up observor to correct css classname when accessible-autocomplete rewrites the input field.
    const typeaheadNode = document.getElementById("typeahead_input");
    const typeaheadError = "{{errors.typeahead_input.text}}";
    var callback;
    var inputClass;

    if (typeaheadError) {
      document.getElementById("my-autocomplete-container").className = "govuk-form-group govuk-form-group--error";
      const errorHtml = '<p id="nationality-error" class="govuk-error-message"> <span class="govuk-visually-hidden">Error:</span> ' + typeaheadError + '</p>'
      const element = document.getElementById("typeahead-hint");
      element.insertAdjacentHTML("afterend", errorHtml);
      inputClass = "govuk-input govuk-input--width-20 govuk-input--error";
      typeaheadNode.className = inputClass;
    }
    else {
      inputClass = "govuk-input govuk-input--width-20";
      typeaheadNode.className = inputClass;
    }

    callback = (mutationList, observer) => {
      for (const mutation of mutationList) {
        if (mutation.type === "attributes") {
          if (typeaheadNode.className !== inputClass) {
            typeaheadNode.className = inputClass;
          }
        }
      }
    };
    const config = { attributes: true, childList: false, subtree: false };
    const observer = new MutationObserver(callback);
    observer.observe(typeaheadNode, config);
  }
</script>

<!-- Javascript disabled -->
<noscript>
  {% set DROPDOWN = [
    { value: '', text: dropdownDefaultText }
  ] %}

  {% for i in typeahead_array.split(',') %}
    {% set dropdownObject = { value: i, text: i, selected: typeahead_value === i } %}
    {% set DROPDOWN = DROPDOWN.concat(dropdownObject) %}
  {% endfor %}

  {{ govukSelect({
    errorMessage: errors.typeahead_input.text if errors,
    id: "typeahead_input",
    name: "typeahead_input",
    value: typeahead_value,
    hint: {
      text: dropdownHint
    },
    items: DROPDOWN
  }) }}
</noscript>
